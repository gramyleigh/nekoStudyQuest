{% extends "base.html" %}

{% block title %}Statistics - {{ test.name }}{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set Chart.js defaults
        Chart.defaults.font.family = "'Comic Neue', cursive";
        Chart.defaults.font.size = 14;
        Chart.defaults.color = "#333";
        Chart.defaults.borderColor = "rgba(106, 90, 205, 0.2)";

        {% if date_counts %}
            // Daily progress chart
            const dailyProgressCtx = document.getElementById('dailyProgressChart').getContext('2d');
            const dailyProgressChart = new Chart(dailyProgressCtx, {
                type: 'bar',
                data: {
                    labels: [{% for date, count in date_counts %}'{{ date }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                    datasets: [{
                        label: 'Resources Completed',
                        data: [{% for date, count in date_counts %}{{ count }}{% if not loop.last %}, {% endif %}{% endfor %}],
                        backgroundColor: 'rgba(106, 90, 205, 0.7)',
                        borderColor: 'rgba(106, 90, 205, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        {% endif %}

        {% if topic_counts %}
            // Topic progress chart
            const topicProgressCtx = document.getElementById('topicProgressChart').getContext('2d');
            const topicProgressChart = new Chart(topicProgressCtx, {
                type: 'pie',
                data: {
                    labels: [{% for topic_name, count in topic_counts.items() %}'{{ topic_name }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                    datasets: [{
                        data: [{% for topic_name, count in topic_counts.items() %}{{ count }}{% if not loop.last %}, {% endif %}{% endfor %}],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    family: "'Comic Neue', cursive",
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        {% endif %}

        {% set has_scores = false %}
        {% set all_scores = [] %}
        {% for topic in test.topics %}
            {% for resource in topic.resources %}
                {% if resource.scores and resource.scores|length > 0 %}
                    {% set has_scores = true %}
                    {% for score in resource.scores %}
                        {% set all_scores = all_scores + [score] %}
                    {% endfor %}
                {% endif %}
            {% endfor %}
        {% endfor %}

        {% if has_scores %}
            // Score Analysis Chart
            const scoreCtx = document.getElementById('scoreChart').getContext('2d');
            const scoreChart = new Chart(scoreCtx, {
                type: 'line',
                data: {
                    labels: [{% for score in all_scores %}'Attempt {{ loop.index }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                    datasets: [{
                        label: 'Score History',
                        data: [{% for score in all_scores %}{{ score }}{% if not loop.last %}, {% endif %}{% endfor %}],
                        borderColor: 'rgba(255, 95, 143, 1)',
                        backgroundColor: 'rgba(255, 95, 143, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        {% endif %}

        {% if date_counts %}
            // Create Activity Heatmap
            const heatmapContainer = document.getElementById('activityHeatmap');
            if (heatmapContainer) {
                // Get data from template
                const heatmapData = [
                    {% for date, count in date_counts %}
                        {date: '{{ date }}', count: {{ count }}},
                    {% endfor %}
                ];

                // Generate past 3 months of dates
                const generateDates = () => {
                    const dates = [];
                    const today = new Date();
                    const startDate = new Date(today);
                    startDate.setDate(startDate.getDate() - 90); // 3 months back

                    for (let d = new Date(startDate); d <= today; d.setDate(d.getDate() + 1)) {
                        dates.push(new Date(d).toISOString().split('T')[0]);
                    }
                    return dates;
                };

                const allDates = generateDates();
                
                // Create heatmap cells
                const heatmapHTML = document.createElement('div');
                heatmapHTML.className = 'heatmap-grid';
                heatmapHTML.style.display = 'grid';
                heatmapHTML.style.gridTemplateColumns = 'repeat(auto-fill, 24px)';
                heatmapHTML.style.gap = '2px';

                // Get maximum count for color intensity scaling
                const maxCount = Math.max(...heatmapData.map(d => d.count));

                // Generate cells for all dates
                allDates.forEach(date => {
                    const dataPoint = heatmapData.find(d => d.date === date);
                    const count = dataPoint ? dataPoint.count : 0;
                    
                    // Create cell
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell';
                    cell.setAttribute('data-date', date);
                    cell.setAttribute('data-count', count);
                    
                    // Style based on activity count
                    if (count === 0) {
                        cell.style.backgroundColor = '#ebedf0';
                    } else {
                        // Calculate color intensity (darker blue for higher counts)
                        const intensity = Math.max(0.2, Math.min(0.9, count / maxCount));
                        cell.style.backgroundColor = `rgba(106, 90, 205, ${intensity})`;
                    }
                    
                    heatmapHTML.appendChild(cell);
                });
                
                heatmapContainer.appendChild(heatmapHTML);
            }
        {% endif %}
    });
</script>
{% endblock %}

{% block page_title %}Statistics for {{ test.name }}{% endblock %}

{% block subtitle %}{{ subject_name }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{{ url_for('index') }}">Home</a>
    <span class="separator">›</span>
    <a href="{{ url_for('subject_details', subject_name=subject_name) }}">{{ subject_name }}</a>
    <span class="separator">›</span>
    <span class="current">{{ test.name }} - Statistics</span>
</div>
{% endblock %}

{% block content %}
<!-- Test Info Card with Countdown -->
<div class="test-info">
    <div class="test-info-header">
        <div class="test-info-main">
            <p><strong>Test:</strong> {{ test.name }}</p>
            <p class="date"><strong>Date:</strong> {{ test.date }}</p>
            
            <!-- Countdown Timer -->
            {% if test.date %}
                {% set test_date = test.date|string|strptime('%Y-%m-%d') %}
                {% set days_remaining = test.days_remaining if test.days_remaining is defined else 0 %}
                
                <div class="countdown-container">
                    <div class="countdown {% if days_remaining <= 7 %}urgent{% elif days_remaining <= 14 %}warning{% else %}normal{% endif %}">
                        {% if days_remaining > 0 %}
                            <span class="countdown-number">{{ days_remaining }}</span>
                            <span class="countdown-label">days left</span>
                        {% elif days_remaining == 0 %}
                            <span class="countdown-number">Today!</span>
                        {% else %}
                            <span class="countdown-label">Test completed</span>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
        
        <!-- Streak Card -->
        <div class="streak-card">
            {% set streak_count = get_streak(subject_name, test.id) if get_streak is defined else 0 %}
            <div class="streak-icon">🔥</div>
            <div class="streak-count">{{ streak_count }}</div>
            <div class="streak-label">day streak</div>
        </div>
    </div>

    <!-- Calculate and display statistics -->
    {% set total_resources = namespace(count=0) %}
    {% set completed_resources = namespace(count=0) %}

    {% for topic in test.topics %}
        {% for resource in topic.resources %}
            {% set total_resources.count = total_resources.count + resource.count %}
            {% set completed_resources.count = completed_resources.count + resource.completed if resource.completed is defined else completed_resources.count %}
        {% endfor %}
    {% endfor %}

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-title">Completion Rate</div>
            <div class="stat-value">
                {{ completed_resources.count }} of {{ total_resources.count }} completed
                {% if total_resources.count > 0 %}
                    ({{ (completed_resources.count / total_resources.count * 100)|round|int }}%)
                {% else %}
                    (0%)
                {% endif %}
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-title">Total Progress</div>
            <div class="progress-container">
                <div class="progress-bar" style="width: {% if total_resources.count > 0 %}{{ (completed_resources.count / total_resources.count * 100)|round|int }}{% else %}0{% endif %}%"></div>
                <span class="progress-percentage">
                    {% if total_resources.count > 0 %}
                        {{ (completed_resources.count / total_resources.count * 100)|round|int }}%
                    {% else %}
                        0%
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
    <div class="cat-paw">🐾</div>
</div>

<!-- Charts Section - Grid Layout -->
<div class="dashboard-grid charts-grid">
    <!-- Daily Progress Chart -->
    <div class="widget chart-widget">
        <div class="widget-header">
            <h3 class="widget-title daily-chart">Daily Progress</h3>
        </div>
        <div class="widget-content">
            {% if date_counts %}
                <div class="chart-wrapper">
                    <canvas id="dailyProgressChart"></canvas>
                </div>
            {% else %}
                <div class="no-data">No progress data available yet. Start tracking your progress!</div>
            {% endif %}
        </div>
    </div>

    <!-- Progress by Topic Chart -->
    <div class="widget chart-widget">
        <div class="widget-header">
            <h3 class="widget-title topic-chart">Progress by Topic</h3>
        </div>
        <div class="widget-content">
            {% if topic_counts %}
                <div class="chart-wrapper">
                    <canvas id="topicProgressChart"></canvas>
                </div>
                
                <!-- Add explicit topic analysis with debug info -->
                <div class="topic-focus-analysis">
                    <h4>Topic Focus Breakdown</h4>
                    <div class="topic-analysis-grid">
                        {% set total_count = namespace(value=0) %}
                        {% for topic_name, count in topic_counts.items() %}
                            {% set total_count.value = total_count.value + count %}
                        {% endfor %}
                        
                        {% for topic_name, count in topic_counts.items() %}
                            <div class="topic-focus-item">
                                <div class="topic-name">{{ topic_name }}</div>
                                <div class="topic-bar-container">
                                    <div class="topic-bar" style="width: {{ (count / total_count.value * 100)|round|int }}%"></div>
                                    <span class="topic-percent">{{ (count / total_count.value * 100)|round|int }}%</span>
                                </div>
                                <div class="topic-count">{{ count }} resources</div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Analysis text -->
                    <div class="analysis-text">
                        {% set max_topic = namespace(name='', count=0) %}
                        {% set min_topic = namespace(name='', count=1000) %}
                        
                        {% for topic_name, count in topic_counts.items() %}
                            {% if count > max_topic.count %}
                                {% set max_topic.name = topic_name %}
                                {% set max_topic.count = count %}
                            {% endif %}
                            {% if count < min_topic.count %}
                                {% set min_topic.name = topic_name %}
                                {% set min_topic.count = count %}
                            {% endif %}
                        {% endfor %}
                        
                        <p><strong>Primary focus:</strong> {{ max_topic.name }} ({{ (max_topic.count / total_count.value * 100)|round|int }}%)</p>
                        
                        {% if topic_counts|length > 1 %}
                            <p><strong>Least focus:</strong> {{ min_topic.name }} ({{ (min_topic.count / total_count.value * 100)|round|int }}%)</p>
                            
                            {% if max_topic.count > (min_topic.count * 2) %}
                                <p class="recommendation">Consider balancing your study by focusing more on {{ min_topic.name }}</p>
                            {% else %}
                                <p class="recommendation positive">Your topic focus is well-balanced!</p>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                
                <div class="stats-distribution">
                    {% for topic_name, count in topic_counts.items() %}
                        <div class="stats-item">
                            <div class="stats-item-title">{{ topic_name }}</div>
                            <div class="stats-item-value">{{ count }} resources completed</div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="no-data">No topic data available yet. Start tracking your progress!</div>
            {% endif %}
        </div>
    </div>

    <!-- Topic Completion Details -->
    <div class="widget topic-details-widget">
        <div class="widget-header">
            <h3 class="widget-title topic-details">Topic Details</h3>
        </div>
        <div class="widget-content">
            <div class="topic-details-wrapper">
                {% if test.topics and test.topics|length > 0 %}
                    <div class="topics-resources-list">
                        {% for topic in test.topics %}
                            <div class="topic-section">
                                <div class="topic-name">{{ topic.name }}</div>
                                <div class="resources-progress-list">
                                    {% if topic.resources and topic.resources|length > 0 %}
                                        {% for resource in topic.resources %}
                                            <div class="resource-progress-item">
                                                <div class="resource-info">
                                                    <div class="resource-name-container">
                                                        <span class="resource-name">{{ resource.name }}</span>
                                                        {% if resource.completed is defined and resource.completed >= resource.count %}
                                                            <span class="completion-check">✓</span>
                                                        {% endif %}
                                                    </div>
                                                    <span class="resource-count">({{ resource.completed if resource.completed is defined else 0 }}/{{ resource.count }})</span>
                                                </div>
                                                <div class="resource-progress-bar">
                                                    <div class="resource-progress" style="width: {{ (resource.completed / resource.count * 100) if resource.completed is defined and resource.count > 0 else 0 }}%"></div>
                                                </div>

                                                <!-- Display average score if available -->
                                                {% if resource.scores and resource.scores|length > 0 %}
                                                    {% set avg_score = (resource.scores|sum / resource.scores|length)|round(1) %}
                                                    <div class="resource-score-container">
                                                        <div class="resource-score {% if avg_score >= 90 %}excellent{% elif avg_score >= 70 %}good{% elif avg_score >= 50 %}average{% else %}needs-work{% endif %}">
                                                            {{ avg_score }}%
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="no-resources">No resources for this topic.</div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="no-data">No topics available yet. Add topics and resources to see details!</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Study Time Analysis -->
    <div class="widget study-time-widget">
        <div class="widget-header">
            <h3 class="widget-title study-time">Study Time Distribution</h3>
        </div>
        <div class="widget-content">
            <div class="study-time-wrapper">
                {% if date_counts %}
                    <div class="study-metrics">
                        {% set total_completed = namespace(count=0) %}
                        {% for date, count in date_counts %}
                            {% set total_completed.count = total_completed.count + count %}
                        {% endfor %}

                        <div class="metric-card">
                            <div class="metric-icon">📚</div>
                            <div class="metric-value">{{ total_completed.count }}</div>
                            <div class="metric-label">Resources Completed</div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon">⏱️</div>
                            <div class="metric-value">{{ (total_completed.count * 0.5)|round(1) }}</div>
                            <div class="metric-label">Study Hours (est.)</div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon">📆</div>
                            <div class="metric-value">{{ date_counts|length }}</div>
                            <div class="metric-label">Study Days</div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon">📈</div>
                            <div class="metric-value">{{ (total_completed.count / date_counts|length)|round(1) if date_counts|length > 0 else 0 }}</div>
                            <div class="metric-label">Daily Average</div>
                        </div>
                    </div>
                {% else %}
                    <div class="no-data">No study time data available yet. Start tracking your progress!</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Score Analysis Widget -->
    <div class="widget score-widget">
        <div class="widget-header">
            <h3 class="widget-title score-analysis">Score Analysis</h3>
        </div>
        <div class="widget-content">
            {% set has_scores = false %}
            {% for topic in test.topics %}
                {% for resource in topic.resources %}
                    {% if resource.scores and resource.scores|length > 0 %}
                        {% set has_scores = true %}
                    {% endif %}
                {% endfor %}
            {% endfor %}

            {% if has_scores %}
                <div class="chart-wrapper">
                    <canvas id="scoreChart"></canvas>
                </div>
                <div class="score-summary">
                    {% set all_scores = [] %}
                    {% for topic in test.topics %}
                        {% for resource in topic.resources %}
                            {% if resource.scores %}
                                {% for score in resource.scores %}
                                    {% set all_scores = all_scores + [score] %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if all_scores|length > 0 %}
                        {% set avg_score = (all_scores|sum / all_scores|length)|round(1) %}
                        <div class="score-summary-item">
                            <div class="summary-label">Average Score:</div>
                            <div class="summary-value {% if avg_score >= 90 %}excellent{% elif avg_score >= 70 %}good{% elif avg_score >= 50 %}average{% else %}needs-work{% endif %}">{{ avg_score }}%</div>
                        </div>
                        <div class="score-summary-item">
                            <div class="summary-label">Highest Score:</div>
                            <div class="summary-value excellent">{{ all_scores|max }}%</div>
                        </div>
                        <div class="score-summary-item">
                            <div class="summary-label">Lowest Score:</div>
                            <div class="summary-value {% set min_score = all_scores|min %}{% if min_score >= 90 %}excellent{% elif min_score >= 70 %}good{% elif min_score >= 50 %}average{% else %}needs-work{% endif %}">{{ min_score }}%</div>
                        </div>
                    {% endif %}
                </div>
            {% else %}
                <div class="no-data">No score data available yet. Add scores when tracking your progress!</div>
            {% endif %}
        </div>
    </div>

    <!-- Activity Heatmap Widget -->
    <div class="widget heatmap-widget">
        <div class="widget-header">
            <h3 class="widget-title activity-heatmap">Activity Calendar</h3>
        </div>
        <div class="widget-content">
            {% if date_counts %}
                <div class="heatmap-wrapper">
                    <div id="activityHeatmap" class="heatmap-container"></div>
                </div>
            {% else %}
                <div class="no-data">No activity data available yet. Start tracking your progress!</div>
            {% endif %}
        </div>
    </div>

    <!-- Study Engagement Timeline -->
    <div class="widget timeline-widget">
        <div class="widget-header">
            <h3 class="widget-title timeline-chart">Study Engagement Timeline</h3>
        </div>
        <div class="widget-content">
            {% if date_counts %}
                <div class="timeline-container">
                    {% set all_dates = [] %}
                    {% for date, count in date_counts %}
                        {% set all_dates = all_dates + [date] %}
                    {% endfor %}
                    {% set all_dates = all_dates|sort %}
                    
                    {% if all_dates|length > 0 %}
                        {% set first_date = all_dates|first|strptime('%Y-%m-%d') %}
                        {% set last_date = all_dates|last|strptime('%Y-%m-%d') %}
                        
                        {% set date_map = {} %}
                        {% for date, count in date_counts %}
                            {% set _ = date_map.update({date: count}) %}
                        {% endfor %}
                        
                        {% set max_count = namespace(value=0) %}
                        {% for date, count in date_counts %}
                            {% if count > max_count.value %}
                                {% set max_count.value = count %}
                            {% endif %}
                        {% endfor %}
                        
                        {% set days_range = ((last_date - first_date).days + 1) %}
                        <div class="timeline">
                            {% for i in range(days_range) %}
                                {% set current_day = first_date + timedelta(days=i) %}
                                {% set display_date = current_day.strftime('%Y-%m-%d') %}
                                <div class="timeline-day">
                                    <div class="timeline-marker {% if display_date in date_map %}active{% endif %}" 
                                        style="{% if display_date in date_map %}--height: {{ (date_map[display_date] / max_count.value * 100)|round|int }}%;{% endif %}">
                                        {% if display_date in date_map %}
                                            <span class="marker-tooltip">{{ date_map[display_date] }} resources on {{ display_date }}</span>
                                        {% endif %}
                                    </div>
                                    {% if loop.index % 5 == 1 or loop.index == 1 %}
                                        <div class="timeline-date">{{ display_date }}</div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                        
                        <div class="timeline-insights">
                            <div class="insight-card">
                                <div class="insight-body">
                                    {% set study_days = all_dates|length %}
                                    {% set consistency = (study_days / days_range * 100)|round|int %}
                                    
                                    {% if study_days > 0 and days_range > 0 %}
                                        {% if consistency >= 80 %}
                                            <p>You've been studying very consistently, covering {{ consistency }}% of the days in your study period!</p>
                                        {% elif consistency >= 50 %}
                                            <p>You have moderate consistency, studying on {{ consistency }}% of days in your study period.</p>
                                        {% else %}
                                            <p>Your study pattern is somewhat inconsistent, with activity on only {{ consistency }}% of days.</p>
                                        {% endif %}
                                    
                                        {% set avg_resources = namespace(per_day=0) %}
                                        {% set total_resources = namespace(count=0) %}
                                        {% for date, count in date_counts %}
                                            {% set total_resources.count = total_resources.count + count %}
                                        {% endfor %}
                                        {% set avg_resources.per_day = (total_resources.count / study_days)|round(1) %}
                                        
                                        <p>On your study days, you complete an average of {{ avg_resources.per_day }} resources.</p>
                                        
                                        {% if consistency < 70 %}
                                            <p>Tip: Try to study more consistently throughout the week for better retention.</p>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            {% else %}
                <div class="no-data">No study activity recorded yet. Start tracking your progress!</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="action-buttons">
    <a href="{{ url_for('track_progress', subject_name=subject_name, test_id=test.id) }}" class="action-button track-button">
        <span class="button-icon">📝</span>
        Track Progress
    </a>
    <a href="{{ url_for('edit_test_topics', subject_name=subject_name, test_id=test.id) }}" class="action-button edit-button">
        <span class="button-icon">✏️</span>
        Edit Topics
    </a>
    <a href="{{ url_for('subject_details', subject_name=subject_name) }}" class="action-button back-button">
        <span class="button-icon">↩️</span>
        Back to Subject
    </a>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Base styles */
    .test-info {
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 15px;
        padding: 25px;
        margin: 30px 0;
        box-shadow: 5px 5px 0 var(--primary-light);
        border: 3px solid var(--primary);
        position: relative;
    }

    .test-info-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .test-info-main {
        flex: 1;
    }

    .test-info p {
        font-size: 1.3rem;
        margin: 8px 0;
    }

    .test-info .date {
        font-weight: bold;
        color: var(--primary-dark);
    }

    /* Countdown styles */
    .countdown-container {
        margin-top: 15px;
    }

    .countdown {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background-color: var(--primary-light);
        padding: 8px 15px;
        border-radius: 12px;
        border: 2px solid var(--dark);
        box-shadow: 3px 3px 0 var(--dark);
    }

    .countdown.urgent {
        background-color: var(--danger);
        color: white;
    }

    .countdown.warning {
        background-color: var(--warning);
    }

    .countdown-number {
        font-size: 1.8rem;
        font-weight: bold;
        margin-right: 5px;
    }

    .countdown-label {
        font-size: 1rem;
    }

    /* Streak Card styles */
    .streak-card {
        background-color: var(--light);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        border: 2px solid var(--dark);
        box-shadow: 3px 3px 0 var(--dark);
        margin-left: 20px;
        min-width: 100px;
    }

    .streak-icon {
        font-size: 1.8rem;
    }

    .streak-count {
        font-size: 2.2rem;
        font-weight: bold;
        color: var(--secondary-dark);
        margin: 5px 0;
    }

    .streak-label {
        font-size: 0.9rem;
        color: var(--dark);
    }

    /* Dashboard Grid Layout */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin: 30px 0;
    }

    .widget {
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 15px;
        padding: 20px;
        border: 3px solid var(--primary);
        box-shadow: 5px 5px 0 var(--primary-light);
        position: relative;
        backdrop-filter: blur(5px);
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .widget:hover {
        transform: translateY(-3px);
        box-shadow: 8px 8px 0 var(--primary-light);
    }

    .widget-header {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px dashed var(--primary-light);
    }

    .widget-title {
        font-family: 'Bangers', cursive;
        color: var(--secondary);
        font-size: 1.6rem;
        margin: 0;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
    }

    .widget-title::before {
        margin-right: 10px;
        font-size: 1.4rem;
    }

    .widget-title.daily-chart::before {
        content: "📅";
    }

    .widget-title.topic-chart::before {
        content: "📊";
    }

    .widget-title.topic-details::before {
        content: "📝";
    }

    .widget-title.study-time::before {
        content: "⏱️";
    }

    .widget-title.score-analysis::before {
        content: "🎯";
    }

    .widget-title.activity-heatmap::before {
        content: "📆";
    }

    .widget-title.timeline-chart::before {
        content: "📅";
    }

    .widget-content {
        height: 300px;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .chart-wrapper {
        position: relative;
        height: 250px;
        width: 100%;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-top: 15px;
    }

    .stat-card {
        background-color: var(--light);
        border-radius: 10px;
        padding: 15px;
        box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.1);
    }

    .stat-title {
        font-weight: bold;
        color: var(--secondary);
        margin-bottom: 10px;
        font-size: 1.1rem;
    }

    .stat-value {
        font-size: 1.2rem;
        color: var(--dark);
    }

    .progress-container {
        position: relative;
        width: 100%;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 5px;
    }

    .progress-bar {
        height: 100%;
        background-color: var(--success);
        transition: width 0.3s ease;
    }

    .progress-percentage {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        text-align: center;
        line-height: 20px;
        font-size: 0.9rem;
        font-weight: bold;
        color: var(--dark);
        text-shadow: 0 0 2px rgba(255, 255, 255, 0.7);
    }

    /* Stats Distribution */
    .stats-distribution {
        margin-top: 15px;
        max-height: 120px;
        overflow-y: auto;
        padding-right: 5px;
    }

    .stats-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 12px;
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        margin-bottom: 6px;
    }

    .stats-item-title {
        font-weight: bold;
    }

    .stats-item-value {
        color: var(--secondary-dark);
    }

    /* Study Metrics */
    .study-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-template-rows: repeat(2, 1fr);
        gap: 15px;
        height: 100%;
        padding: 10px;
    }

    .metric-card {
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
    }

    .metric-icon {
        font-size: 2rem;
        margin-bottom: 5px;
    }

    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--secondary-dark);
    }

    .metric-label {
        font-size: 0.9rem;
        color: var(--dark);
    }

    /* Topic Details */
    .topics-resources-list {
        max-height: 280px;
        overflow-y: auto;
        padding-right: 10px;
    }

    .topic-section {
        margin-bottom: 15px;
    }

    .topic-name {
        font-weight: bold;
        font-size: 1.1rem;
        color: var(--secondary);
        padding: 5px 10px;
        margin-bottom: 8px;
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        border-left: 4px solid var(--secondary);
    }

    .resources-progress-list {
        margin-left: 10px;
    }

    .resource-progress-item {
        margin-bottom: 10px;
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        padding: 10px;
        position: relative;
    }

    .resource-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }

    .resource-name-container {
        display: flex;
        align-items: center;
    }

    .resource-name {
        font-weight: bold;
        color: var(--dark);
    }

    .completion-check {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        background-color: var(--success);
        color: white;
        border-radius: 50%;
        margin-left: 8px;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .resource-count {
        font-size: 0.9rem;
        color: var(--dark);
    }

    .resource-progress-bar {
        height: 10px;
        background-color: #f0f0f0;
        border-radius: 5px;
        overflow: hidden;
    }

    .resource-progress {
        height: 100%;
        background-color: var(--success);
        transition: width 0.3s ease;
    }

    /* Score styles */
    .resource-score-container {
        margin-top: 5px;
        display: flex;
        justify-content: flex-end;
    }

    .resource-score {
        font-size: 0.9rem;
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 10px;
    }

    .resource-score.excellent {
        background-color: #66bb6a;
        color: white;
    }

    .resource-score.good {
        background-color: #26a69a;
        color: white;
    }

    .resource-score.average {
        background-color: #ffb74d;
        color: var(--dark);
    }

    .resource-score.needs-work {
        background-color: #ef5350;
        color: white;
    }

    /* Score Analysis Styles */
    .score-summary {
        margin-top: 10px;
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 10px;
    }

    .score-summary-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px dashed rgba(169, 149, 239, 0.3);
    }

    .score-summary-item:last-child {
        border-bottom: none;
    }

    .summary-label {
        font-weight: bold;
    }

    .summary-value {
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 10px;
    }

    /* Heatmap styles */
    .heatmap-container {
        height: 100%;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .heatmap-cell {
        width: 20px;
        height: 20px;
        margin: 2px;
        border-radius: 4px;
        position: relative;
    }

    .heatmap-cell:hover::after {
        content: attr(data-date) " - " attr(data-count) " resources";
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 3px 8px;
        border-radius: 5px;
        font-size: 0.8rem;
        white-space: nowrap;
        z-index: 10;
    }

    .no-resources, .no-data {
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        font-style: italic;
        color: var(--dark);
        background-color: rgba(255, 255, 255, 0.5);
        border-radius: 10px;
        border: 1px dashed var(--primary);
        padding: 20px;
    }

    /* Action buttons */
    .action-buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 30px 0;
        flex-wrap: wrap;
    }

    .action-button {
        display: flex;
        align-items: center;
        padding: 12px 25px;
        background-color: var(--light);
        border: 2px solid var(--dark);
        border-radius: 15px;
        font-family: 'Comic Neue', cursive;
        font-weight: bold;
        font-size: 1rem;
        text-decoration: none;
        color: var(--dark);
        box-shadow: 3px 3px 0 var(--dark);
        transition: all 0.3s ease;
    }

    .action-button:hover {
        transform: translateY(-3px);
        box-shadow: 5px 5px 0 var(--dark);
    }

    .button-icon {
        font-size: 1.3rem;
        margin-right: 8px;
    }

    .track-button {
        background-color: var(--secondary);
        color: white;
    }

    .edit-button {
        background-color: var(--primary);
        color: white;
    }

    .back-button {
        background-color: var(--light);
        color: var(--dark);
    }

    /* Chart Decorations */
    .chart-corner {
        position: absolute;
        font-size: 1.5rem;
        z-index: 1;
    }

    .chart-corner.top-left {
        top: 5px;
        left: 5px;
    }

    .chart-corner.top-right {
        top: 5px;
        right: 5px;
    }

    .chart-corner.bottom-left {
        bottom: 5px;
        left: 5px;
    }

    .chart-corner.bottom-right {
        bottom: 5px;
        right: 5px;
    }

    .cat-paw {
        position: absolute;
        bottom: -15px;
        right: -15px;
        font-size: 1.8rem;
        transform: rotate(15deg);
    }

    /* Responsive Design */
    @media (max-width: 992px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .action-buttons {
            flex-direction: column;
            align-items: center;
        }

        .action-button {
            width: 80%;
        }

        .widget-content {
            height: 250px;
        }

        .test-info-header {
            flex-direction: column;
        }

        .streak-card {
            margin-left: 0;
            margin-top: 15px;
            width: fit-content;
        }
    }

    @media (max-width: 576px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }

        .study-metrics {
            grid-template-columns: 1fr;
        }
    }

    /* Timeline Styles */
    .timeline-container {
        width: 100%;
        height: 100%;
        overflow-x: auto;
        padding: 15px 0;
    }

    .timeline {
        display: flex;
        align-items: flex-end;
        height: 150px;
        width: max-content;
        min-width: 100%;
        padding-bottom: 25px;
    }

    .timeline-day {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        min-width: 24px;
        height: 100%;
        position: relative;
    }

    .timeline-marker {
        width: 12px;
        height: 10px;
        background-color: #e0e0e0;
        border-radius: 2px;
        margin-bottom: 5px;
        position: relative;
    }

    .timeline-marker.active {
        background-color: var(--primary);
        height: var(--height, 50%);
        min-height: 20px;
    }

    .timeline-marker .marker-tooltip {
        display: none;
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.8rem;
        white-space: nowrap;
        z-index: 10;
        margin-bottom: 5px;
    }

    .timeline-marker:hover .marker-tooltip {
        display: block;
    }

    .timeline-date {
        transform: rotate(-45deg);
        transform-origin: top left;
        font-size: 0.7rem;
        position: absolute;
        bottom: 0;
        left: 12px;
        white-space: nowrap;
    }

    /* Topic analysis insights */
    .topic-analysis-insights {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px dashed var(--light-border);
    }

    .analysis-subtitle {
        font-size: 1.1rem;
        color: var(--primary-dark);
        margin-bottom: 12px;
        font-weight: 600;
    }

    .insight-card {
        background-color: rgba(106, 90, 205, 0.05);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
    }

    .insight-body {
        font-size: 0.95rem;
        line-height: 1.4;
        color: var(--dark);
    }

    .insight-body p {
        margin: 0 0 8px 0;
    }

    .insight-body p:last-child {
        margin-bottom: 0;
    }

    .insight-body strong {
        color: var(--primary-dark);
        font-weight: 600;
    }
    
    /* Topic Focus Analysis Styles */
    .topic-focus-analysis {
        margin-top: 15px;
        padding: 15px;
        background-color: rgba(255, 255, 255, 0.6);
        border-radius: 10px;
        border: 1px solid var(--primary-light);
    }
    
    .topic-focus-analysis h4 {
        margin-top: 0;
        margin-bottom: 15px;
        color: var(--primary-dark);
        font-weight: bold;
        font-size: 1.1rem;
    }
    
    .topic-analysis-grid {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .topic-focus-item {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .topic-name {
        width: 120px;
        font-weight: 600;
        color: var(--dark);
    }
    
    .topic-bar-container {
        flex: 1;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        position: relative;
        overflow: hidden;
        min-width: 100px;
    }
    
    .topic-bar {
        height: 100%;
        background-color: var(--primary);
        border-radius: 10px;
    }
    
    .topic-percent {
        position: absolute;
        top: 0;
        left: 8px;
        line-height: 20px;
        font-size: 0.8rem;
        font-weight: bold;
        color: white;
        text-shadow: 0 0 2px rgba(0,0,0,0.5);
    }
    
    .topic-count {
        width: 100px;
        text-align: right;
        font-size: 0.9rem;
        color: var(--dark);
    }
    
    .analysis-text {
        padding: 10px;
        border-radius: 8px;
        background-color: rgba(106, 90, 205, 0.05);
    }
    
    .analysis-text p {
        margin: 5px 0;
        font-size: 0.95rem;
    }
    
    .recommendation {
        margin-top: 10px;
        font-style: italic;
        color: var(--warning-dark);
    }
    
    .recommendation.positive {
        color: var(--success-dark);
    }
</style>
{% endblock %}