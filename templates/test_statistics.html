{% extends "base.html" %}

{% block title %}Statistics - {{ test.name }}{% endblock %}

{% block page_title %}Statistics for {{ test.name }}{% endblock %}

{% block subtitle %}{{ subject_name }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{{ url_for('index') }}">Home</a>
    <span class="separator">‚Ä∫</span>
    <a href="{{ url_for('subject_details', subject_name=subject_name) }}">{{ subject_name }}</a>
    <span class="separator">‚Ä∫</span>
    <span class="current">{{ test.name }} - Statistics</span>
</div>
{% endblock %}

{% block content %}
<!-- Test Info Card -->
<div class="test-info">
    <p><strong>Test:</strong> {{ test.name }}</p>
    <p class="date"><strong>Date:</strong> {{ test.date }}</p>
    
    {% if test.date %}
        {% if test.days_remaining is defined %}
            <p class="date">
                <strong>Status:</strong> 
                {% if test.days_remaining < 0 %}
                    <span class="past-test">Past test ({{ test.days_remaining|abs }} days ago)</span>
                {% elif test.days_remaining == 0 %}
                    <span class="today-test">Today!</span>
                {% elif test.days_remaining <= 7 %}
                    <span class="urgent-test">Urgent! {{ test.days_remaining }} days left</span>
                {% elif test.days_remaining <= 14 %}
                    <span class="soon-test">Coming soon - {{ test.days_remaining }} days left</span>
                {% else %}
                    <span class="future-test">{{ test.days_remaining }} days left</span>
                {% endif %}
            </p>
        {% endif %}
    {% endif %}

    <!-- Calculate and display statistics -->
    {% set total_resources = namespace(count=0) %}
    {% set completed_resources = namespace(count=0) %}

    {% for topic in test.topics %}
        {% for resource in topic.resources %}
            {% set total_resources.count = total_resources.count + resource.count %}
            {% set completed_resources.count = completed_resources.count + resource.completed if resource.completed is defined else completed_resources.count %}
        {% endfor %}
    {% endfor %}

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-title">Completion Rate</div>
            <div class="stat-value">
                {{ completed_resources.count }} of {{ total_resources.count }} completed
                {% if total_resources.count > 0 %}
                    ({{ (completed_resources.count / total_resources.count * 100)|round|int }}%)
                {% else %}
                    (0%)
                {% endif %}
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-title">Total Progress</div>
            <div class="progress-container">
                <div class="progress-bar" style="width: {% if total_resources.count > 0 %}{{ (completed_resources.count / total_resources.count * 100)|round|int }}{% else %}0{% endif %}%"></div>
                <span class="progress-percentage">
                    {% if total_resources.count > 0 %}
                        {{ (completed_resources.count / total_resources.count * 100)|round|int }}%
                    {% else %}
                        0%
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
    
    <!-- Study Streak -->
    {% if date_counts %}
        {% set streak = namespace(count=0, current=0) %}
        {% set dates = [] %}
        
        {% for date_str, count in date_counts %}
            {% if dates.append(date_str) %}{% endif %}
        {% endfor %}
        
        {% if dates|length > 0 %}
            {% set dates = dates|sort %}
            {% set last_date = dates[-1] %}
            
            <!-- Calculate current streak - using a simpler approach -->
            {% set streak_counter = namespace(current=1, should_continue=true) %}
            {% for i in range(dates|length - 2, -1, -1) %}
                {% if streak_counter.should_continue %}
                    {% set prev_date = dates[i] %}
                    {% set days_diff = 1 %} <!-- Placeholder - ideally calculate actual difference -->
                    
                    {% if days_diff == 1 %}
                        {% set streak_counter.current = streak_counter.current + 1 %}
                    {% else %}
                        {% set streak_counter.should_continue = false %}
                    {% endif %}
                {% endif %}
            {% endfor %}
            
            {% set streak.current = streak_counter.current %}
            
            <div class="stat-card streak-card">
                <div class="stat-title">Current Streak</div>
                <div class="stat-value">{{ streak.current }} day{{ 's' if streak.current != 1 }}</div>
            </div>
        {% endif %}
    {% endif %}
    
    <div class="cat-paw">üêæ</div>
</div>

<!-- Charts Section - Grid Layout -->
<div class="dashboard-grid charts-grid">
    <!-- Daily Progress Chart -->
    <div class="widget chart-widget">
        <div class="widget-header">
            <h3 class="widget-title daily-chart">Daily Progress</h3>
        </div>
        <div class="widget-content">
            {% if date_counts %}
                <div class="chart-wrapper">
                    <canvas id="dailyProgressChart"></canvas>
                </div>
                
                <!-- Estimated readiness calculation -->
                {% set consistency = namespace(score=0) %}
                {% if date_counts|length > 0 %}
                    <!-- Higher consistency score for regular studying -->
                    {% set consistency.score = 25 * (date_counts|length / 14) %}
                    <!-- Cap at 25% -->
                    {% if consistency.score > 25 %}
                        {% set consistency.score = 25 %}
                    {% endif %}
                {% endif %}
                
                {% set progress_score = 0 %}
                {% if total_resources.count > 0 %}
                    {% set progress_score = 50 * (completed_resources.count / total_resources.count) %}
                {% endif %}
                
                {% set readiness = consistency.score + progress_score %}
                {% if readiness > 75 %}
                    {% set readiness_class = "excellent" %}
                {% elif readiness > 50 %}
                    {% set readiness_class = "good" %}
                {% elif readiness > 25 %}
                    {% set readiness_class = "fair" %}
                {% else %}
                    {% set readiness_class = "poor" %}
                {% endif %}
                
                <div class="readiness-score {{ readiness_class }}">
                    <div class="readiness-title">Estimated Readiness</div>
                    <div class="readiness-value">{{ readiness|round|int }}%</div>
                    <div class="readiness-bar">
                        <div class="readiness-progress" style="width: {{ readiness|round|int }}%"></div>
                    </div>
                </div>
            {% else %}
                <div class="no-data">No progress data available yet. Start tracking your progress!</div>
            {% endif %}
        </div>
    </div>

    <!-- Progress by Topic Chart -->
    <div class="widget chart-widget">
        <div class="widget-header">
            <h3 class="widget-title topic-chart">Progress by Topic</h3>
        </div>
        <div class="widget-content">
            {% if topic_counts %}
                <div class="chart-wrapper">
                    <canvas id="topicProgressChart"></canvas>
                </div>
                <div class="stats-distribution">
                    {% for topic_name, count in topic_counts.items() %}
                        <div class="stats-item">
                            <div class="stats-item-title">{{ topic_name }}</div>
                            <div class="stats-item-value">{{ count }} resources completed</div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="no-data">No topic data available yet. Start tracking your progress!</div>
            {% endif %}
        </div>
    </div>

    <!-- Topic Completion Details -->
    <div class="widget topic-details-widget">
        <div class="widget-header">
            <h3 class="widget-title topic-details">Topic Details</h3>
        </div>
        <div class="widget-content">
            <div class="topic-details-wrapper">
                {% if test.topics and test.topics|length > 0 %}
                    <div class="topics-resources-list">
                        {% for topic in test.topics %}
                            <div class="topic-section">
                                <div class="topic-name">{{ topic.name }}</div>
                                <div class="resources-progress-list">
                                    {% if topic.resources and topic.resources|length > 0 %}
                                        {% for resource in topic.resources %}
                                            <div class="resource-progress-item">
                                                <div class="resource-info">
                                                    <div class="resource-name-container">
                                                        <span class="resource-name">{{ resource.name }}</span>
                                                        {% if resource.completed is defined and resource.completed >= resource.count %}
                                                            <span class="completion-check">‚úì</span>
                                                        {% endif %}
                                                    </div>
                                                    <span class="resource-count">({{ resource.completed if resource.completed is defined else 0 }}/{{ resource.count }})</span>
                                                </div>
                                                <div class="resource-progress-bar">
                                                    <div class="resource-progress" style="width: {{ (resource.completed / resource.count * 100) if resource.completed is defined and resource.count > 0 else 0 }}%"></div>
                                                </div>
                                                
                                                <!-- Display scores if they exist -->
                                                {% if resource.scores and resource.scores|length > 0 %}
                                                    <div class="resource-scores">
                                                        <span class="score-label">Scores:</span>
                                                        {% for score in resource.scores %}
                                                            <span class="score-badge">{{ score }}%</span>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="no-resources">No resources for this topic.</div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="no-data">No topics available yet. Add topics and resources to see details!</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Study Time Analysis -->
    <div class="widget study-time-widget">
        <div class="widget-header">
            <h3 class="widget-title study-time">Study Time Distribution</h3>
        </div>
        <div class="widget-content">
            <div class="study-time-wrapper">
                {% if date_counts %}
                    <div class="study-metrics">
                        {% set total_completed = namespace(count=0) %}
                        {% for date, count in date_counts %}
                            {% set total_completed.count = total_completed.count + count %}
                        {% endfor %}

                        <div class="metric-card">
                            <div class="metric-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                </svg>
                            </div>
                            <div class="metric-value">{{ total_completed.count }}</div>
                            <div class="metric-label">Resources Completed</div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                            </div>
                            <div class="metric-value">{{ (total_completed.count * 0.5)|round(1) }}</div>
                            <div class="metric-label">Study Hours (est.)</div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                            </div>
                            <div class="metric-value">{{ date_counts|length }}</div>
                            <div class="metric-label">Study Days</div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                </svg>
                            </div>
                            <div class="metric-value">{{ (total_completed.count / date_counts|length)|round(1) if date_counts|length > 0 else 0 }}</div>
                            <div class="metric-label">Daily Average</div>
                        </div>
                    </div>
                {% else %}
                    <div class="no-data">No study time data available yet. Start tracking your progress!</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="button-group">
    <a href="{{ url_for('track_progress', subject_name=subject_name, test_id=test.id) }}" class="btn btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="btn-icon">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        Track Progress
    </a>
    
    <a href="{{ url_for('subject_details', subject_name=subject_name) }}" class="btn btn-secondary">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="btn-icon">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        Back to Subject
    </a>
    
    <!-- Reminder Widget Toggle Button -->
    <button type="button" class="btn btn-secondary" id="reminderToggleBtn">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="btn-icon">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
        Email Reminders
    </button>
</div>

<!-- Foldable Email Reminder Widget -->
<div class="reminder-widget" id="reminderWidget">
    <div class="reminder-header">
        <h3 class="reminder-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="reminder-icon">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
            Email Reminders
        </h3>
        <button type="button" class="reminder-close" id="reminderCloseBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>
    
    <div class="reminder-content">
        <form id="reminderForm" action="{{ url_for('send_test_reminder', subject_name=subject_name, test_id=test.id) }}" method="post">
            <!-- Reminder Type Selection -->
            <div class="reminder-section">
                <label for="reminderType" class="reminder-label">Reminder Type</label>
                <select id="reminderType" name="reminderType" class="reminder-select">
                    <option value="test_reminder">Test Reminders</option>
                    <option value="progress_report">Progress Reports</option>
                    <option value="completion_alert">Completion Alerts</option>
                    <option value="study_streak">Streak Notifications</option>
                    <option value="custom">Custom Message</option>
                </select>
            </div>
            
            <!-- Frequency Selection -->
            <div class="reminder-section">
                <label for="reminderFrequency" class="reminder-label">Frequency</label>
                <select id="reminderFrequency" name="reminderFrequency" class="reminder-select">
                    <option value="once">One-time</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="milestone">At Milestones (25%, 50%, 75%)</option>
                    <option value="days_before">Days Before Test</option>
                </select>
            </div>
            
            <!-- Days Before Test (conditionally shown) -->
            <div class="reminder-section days-before-options">
                <label class="reminder-label">Days Before Test</label>
                <div class="days-before-checkboxes">
                    <label class="checkbox-label">
                        <input type="checkbox" name="days_before[]" value="7" checked> 7 days
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="days_before[]" value="3" checked> 3 days
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="days_before[]" value="1" checked> 1 day
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="days_before[]" value="0"> Day of test
                    </label>
                </div>
            </div>
            
            <!-- Delivery Time -->
            <div class="reminder-section">
                <label for="reminderTime" class="reminder-label">Delivery Time</label>
                <input type="time" id="reminderTime" name="reminderTime" value="08:00" class="reminder-time">
            </div>
            
            <!-- Custom Message (conditionally shown) -->
            <div class="reminder-section custom-message-section">
                <label for="customMessage" class="reminder-label">Custom Message</label>
                <textarea id="customMessage" name="customMessage" class="reminder-textarea" placeholder="Enter your custom reminder message here..."></textarea>
            </div>
            
            <!-- Submit Button -->
            <button type="submit" class="reminder-submit-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="reminder-btn-icon">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
                Schedule Reminders
            </button>
        </form>
        
        <!-- Active Reminders Section -->
        <div class="active-reminders">
            <h4 class="active-reminders-title">Active Reminders</h4>
            
            <div class="active-reminder-item">
                <div class="active-reminder-info">
                    <div class="active-reminder-type">Test Reminder</div>
                    <div class="active-reminder-schedule">7, 3, 1 days before test at 8:00 AM</div>
                </div>
                <button type="button" class="active-reminder-delete">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>
            
            <div class="active-reminder-item">
                <div class="active-reminder-info">
                    <div class="active-reminder-type">Progress Report</div>
                    <div class="active-reminder-schedule">Weekly on Monday at 9:00 AM</div>
                </div>
                <button type="button" class="active-reminder-delete">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Base styles */
    .test-info {
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 15px;
        padding: 25px;
        margin: 30px 0;
        box-shadow: 5px 5px 0 var(--primary-light);
        border: 3px solid var(--primary);
        position: relative;
    }

    .test-info p {
        font-size: 1.3rem;
        margin: 8px 0;
    }

    .test-info .date {
        font-weight: bold;
        color: var(--primary-dark);
    }
    
    /* Status colors */
    .past-test {
        color: var(--dark);
    }
    .today-test {
        color: #ff5f8f;
        font-weight: bold;
    }
    .urgent-test {
        color: var(--danger);
        font-weight: bold;
    }
    .soon-test {
        color: var(--warning);
        font-weight: bold;
    }
    .future-test {
        color: var(--success);
    }

    /* Readiness score */
    .readiness-score {
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 10px;
        padding: 15px;
        margin-top: 15px;
        text-align: center;
    }
    
    .readiness-title {
        font-weight: bold;
        font-size: 1.1rem;
        margin-bottom: 5px;
    }
    
    .readiness-value {
        font-size: 1.8rem;
        font-weight: bold;
        margin: 5px 0;
    }
    
    .readiness-bar {
        height: 10px;
        background-color: #f0f0f0;
        border-radius: 5px;
        overflow: hidden;
        margin-top: 10px;
    }
    
    .readiness-progress {
        height: 100%;
        transition: width 0.3s ease;
    }
    
    .excellent .readiness-value {
        color: #4CAF50;
    }
    
    .excellent .readiness-progress {
        background-color: #4CAF50;
    }
    
    .good .readiness-value {
        color: #8BC34A;
    }
    
    .good .readiness-progress {
        background-color: #8BC34A;
    }
    
    .fair .readiness-value {
        color: #FFC107;
    }
    
    .fair .readiness-progress {
        background-color: #FFC107;
    }
    
    .poor .readiness-value {
        color: #FF5722;
    }
    
    .poor .readiness-progress {
        background-color: #FF5722;
    }

    /* Dashboard Grid Layout */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin: 30px 0;
    }

    .widget {
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 15px;
        padding: 20px;
        border: 3px solid var(--primary);
        box-shadow: 5px 5px 0 var(--primary-light);
        position: relative;
        backdrop-filter: blur(5px);
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .widget:hover {
        transform: translateY(-3px);
        box-shadow: 8px 8px 0 var(--primary-light);
    }

    .widget-header {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px dashed var(--primary-light);
    }

    .widget-title {
        font-family: 'Bangers', cursive;
        color: var(--secondary);
        font-size: 1.6rem;
        margin: 0;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
    }

    .widget-title::before {
        margin-right: 10px;
        width: 24px;
        height: 24px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .widget-title.daily-chart::before {
        content: "";
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23546079' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
    }

    .widget-title.topic-chart::before {
        content: "";
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23546079' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 3v18h18'%3E%3C/path%3E%3Cpath d='M18.4 8l-5.3 5.3-2.7-2.7-3 3'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
    }

    .widget-title.topic-details::before {
        content: "";
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23546079' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z'%3E%3C/path%3E%3Cpolyline points='14 2 14 8 20 8'%3E%3C/polyline%3E%3Cline x1='16' y1='13' x2='8' y2='13'%3E%3C/line%3E%3Cline x1='16' y1='17' x2='8' y2='17'%3E%3C/line%3E%3Cpolyline points='10 9 9 9 8 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
    }

    .widget-title.study-time::before {
        content: "";
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23546079' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cpolyline points='12 6 12 12 16 14'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
    }

    .widget-content {
        height: 300px;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .chart-wrapper {
        width: 100%;
        flex: 1;
        min-height: 0; /* Important for flex container to allow proper sizing */
        position: relative;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-top: 15px;
    }

    .stat-card {
        background-color: var(--light);
        border-radius: 10px;
        padding: 15px;
        box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.1);
    }

    .stat-title {
        font-weight: bold;
        color: var(--secondary);
        margin-bottom: 10px;
        font-size: 1.1rem;
    }

    .stat-value {
        font-size: 1.2rem;
        color: var(--dark);
    }

    .progress-container {
        position: relative;
        width: 100%;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 5px;
    }

    .progress-bar {
        height: 100%;
        background-color: var(--success);
        transition: width 0.3s ease;
    }

    .progress-percentage {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        text-align: center;
        line-height: 20px;
        font-size: 0.9rem;
        font-weight: bold;
        color: var(--dark);
        text-shadow: 0 0 2px rgba(255, 255, 255, 0.7);
    }

    /* Stats Distribution */
    .stats-distribution {
        margin-top: 15px;
        max-height: 120px;
        overflow-y: auto;
        padding-right: 5px;
    }

    .stats-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 12px;
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        margin-bottom: 6px;
    }

    .stats-item-title {
        font-weight: bold;
    }

    .stats-item-value {
        color: var(--secondary-dark);
    }

    /* Study Metrics */
    .study-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-template-rows: repeat(2, 1fr);
        gap: 15px;
        height: 100%;
        padding: 10px;
    }

    .metric-card {
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .metric-icon {
        font-size: 2rem;
        margin-bottom: 5px;
        color: var(--secondary);
    }

    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--secondary-dark);
    }

    .metric-label {
        font-size: 0.9rem;
        color: var(--dark);
    }

    /* Topic Details */
    .topics-resources-list {
        max-height: 280px;
        overflow-y: auto;
        padding-right: 10px;
    }

    .topic-section {
        margin-bottom: 15px;
    }

    .topic-name {
        font-weight: bold;
        font-size: 1.1rem;
        color: var(--secondary);
        padding: 5px 10px;
        margin-bottom: 8px;
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        border-left: 4px solid var(--secondary);
    }

    .resources-progress-list {
        margin-left: 10px;
    }

    .resource-progress-item {
        margin-bottom: 10px;
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        padding: 10px;
    }

    .resource-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }

    .resource-name-container {
        display: flex;
        align-items: center;
    }

    .resource-name {
        font-weight: bold;
        color: var(--dark);
    }

    .completion-check {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        background-color: var(--success);
        color: white;
        border-radius: 50%;
        margin-left: 8px;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .resource-count {
        font-size: 0.9rem;
        color: var(--dark);
    }

    .resource-progress-bar {
        height: 10px;
        background-color: #f0f0f0;
        border-radius: 5px;
        overflow: hidden;
    }

    .resource-progress {
        height: 100%;
        background-color: var(--success);
        transition: width 0.3s ease;
    }
    
    /* Resource Scores */
    .resource-scores {
        margin-top: 8px;
        font-size: 0.9rem;
    }
    
    .score-label {
        font-style: italic;
        margin-right: 5px;
    }
    
    .score-badge {
        background-color: var(--secondary-light);
        padding: 2px 6px;
        border-radius: 10px;
        margin-right: 5px;
        font-size: 0.8rem;
    }

    .no-resources, .no-data {
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        font-style: italic;
        color: var(--dark);
        background-color: rgba(255, 255, 255, 0.5);
        border-radius: 10px;
        border: 1px dashed var(--primary);
        padding: 20px;
    }

    /* Streak Card */
    .streak-card {
        grid-column: 1 / span 2;
        margin-top: 15px;
        background-color: var(--primary-light);
        border-left: 4px solid var(--primary);
        transition: all 0.3s ease;
    }
    
    .streak-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .streak-card .stat-title {
        color: var(--primary-dark);
    }
    
    .streak-card .stat-value {
        font-size: 1.4rem;
        font-weight: bold;
        color: var(--primary-dark);
    }

    /* Button Group */
    .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin-top: 30px;
    }

    .btn {
        padding: 12px 20px;
        border-radius: 10px;
        font-family: 'Comic Neue', cursive;
        font-weight: bold;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        border: 2px solid var(--dark);
        box-shadow: 3px 3px 0 var(--dark);
    }

    .btn:hover {
        transform: translateY(-3px);
        box-shadow: 5px 5px 0 var(--dark);
    }

    .btn-primary {
        background-color: var(--secondary);
        color: white;
    }

    .btn-secondary {
        background-color: var(--primary);
        color: white;
    }

    .btn-icon {
        margin-right: 8px;
        font-size: 1.2rem;
    }

    .cat-paw {
        position: absolute;
        bottom: -15px;
        right: -15px;
        font-size: 1.8rem;
        transform: rotate(15deg);
    }

    /* Reminder Widget Styles */
    .reminder-widget {
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        border: 3px solid var(--primary);
        box-shadow: 5px 5px 0 var(--primary-light);
        margin: 25px auto;
        max-width: 600px;
        overflow: hidden;
        display: none;
        transition: all 0.3s ease-in-out;
        opacity: 0;
        transform: translateY(-20px);
    }
    
    .reminder-widget.active {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }
    
    .reminder-header {
        background-color: var(--primary-light);
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px dashed var(--primary);
    }
    
    .reminder-title {
        margin: 0;
        font-size: 1.3rem;
        color: var(--primary-dark);
        display: flex;
        align-items: center;
    }
    
    .reminder-icon {
        margin-right: 10px;
        color: var(--primary-dark);
    }
    
    .reminder-close {
        background: none;
        border: none;
        color: var(--dark);
        cursor: pointer;
        padding: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
    }
    
    .reminder-close:hover {
        background-color: rgba(255, 255, 255, 0.6);
        transform: scale(1.1);
    }
    
    .reminder-content {
        padding: 20px;
    }
    
    .reminder-section {
        margin-bottom: 15px;
    }
    
    .reminder-label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: var(--dark);
    }
    
    .reminder-select,
    .reminder-time,
    .reminder-textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid rgba(169, 149, 239, 0.3);
        border-radius: 8px;
        font-family: 'Comic Neue', cursive;
        background-color: white;
    }
    
    .reminder-textarea {
        height: 100px;
        resize: vertical;
    }
    
    .checkbox-label {
        display: inline-flex;
        align-items: center;
        margin-right: 15px;
        margin-bottom: 8px;
        cursor: pointer;
    }
    
    .checkbox-label input {
        margin-right: 5px;
    }
    
    .days-before-options,
    .custom-message-section {
        display: none;
    }
    
    .days-before-options.active,
    .custom-message-section.active {
        display: block;
        animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .days-before-checkboxes {
        display: flex;
        flex-wrap: wrap;
    }
    
    .reminder-submit-btn {
        background-color: var(--secondary);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 18px;
        font-family: 'Comic Neue', cursive;
        font-weight: bold;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        margin-top: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .reminder-submit-btn:hover {
        background-color: var(--secondary-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .reminder-btn-icon {
        margin-right: 8px;
    }
    
    /* Active Reminders Section */
    .active-reminders {
        margin-top: 25px;
        border-top: 1px dashed var(--primary-light);
        padding-top: 15px;
    }
    
    .active-reminders-title {
        font-size: 1.1rem;
        color: var(--secondary-dark);
        margin-bottom: 15px;
        padding-bottom: 5px;
        border-bottom: 1px solid rgba(146, 193, 255, 0.3);
    }
    
    .active-reminder-item {
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        border-left: 3px solid var(--secondary-light);
        transition: all 0.2s ease;
    }
    
    .active-reminder-item:hover {
        background-color: rgba(255, 255, 255, 0.95);
        transform: translateX(3px);
        box-shadow: 0 3px 7px rgba(0, 0, 0, 0.08);
    }
    
    .active-reminder-type {
        font-weight: bold;
        color: var(--secondary-dark);
        margin-bottom: 3px;
    }
    
    .active-reminder-schedule {
        font-size: 0.9rem;
        color: var(--dark);
    }
    
    .active-reminder-delete {
        background: none;
        border: none;
        color: var(--danger);
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    
    .active-reminder-delete:hover {
        background-color: rgba(255, 179, 192, 0.2);
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    // JavaScript to create charts
    document.addEventListener('DOMContentLoaded', function() {
        // Set Chart.js defaults
        Chart.defaults.font.family = "'Comic Neue', cursive";
        Chart.defaults.font.size = 14;
        Chart.defaults.color = "#333";
        Chart.defaults.borderColor = "rgba(106, 90, 205, 0.2)";

        // Safely get element and check if it exists before creating charts
        const dailyProgressCtx = document.getElementById('dailyProgressChart');
        const topicProgressCtx = document.getElementById('topicProgressChart');

        {% if date_counts %}
            // Only initialize if the element exists
            if (dailyProgressCtx) {
                const dailyProgressChart = new Chart(dailyProgressCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: [{% for date, count in date_counts %}'{{ date }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                        datasets: [{
                            label: 'Resources Completed',
                            data: [{% for date, count in date_counts %}{{ count }}{% if not loop.last %}, {% endif %}{% endfor %}],
                            backgroundColor: 'rgba(106, 90, 205, 0.7)',
                            borderColor: 'rgba(106, 90, 205, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(tooltipItems) {
                                        return tooltipItems[0].label;
                                    },
                                    label: function(context) {
                                        const resources = context.raw;
                                        return `${resources} resource${resources !== 1 ? 's' : ''} completed`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        {% endif %}

        {% if topic_counts %}
            // Only initialize if the element exists
            if (topicProgressCtx) {
                // Generate dynamic colors for better visualization
                const generateColors = (count) => {
                    // Expanded color palette with more options
                    const baseColors = [
                        'rgba(255, 99, 132, 0.7)',    // Pink
                        'rgba(54, 162, 235, 0.7)',    // Blue
                        'rgba(255, 206, 86, 0.7)',    // Yellow
                        'rgba(75, 192, 192, 0.7)',    // Teal
                        'rgba(153, 102, 255, 0.7)',   // Purple
                        'rgba(255, 159, 64, 0.7)',    // Orange
                        'rgba(129, 199, 132, 0.7)',   // Green
                        'rgba(121, 134, 203, 0.7)',   // Indigo
                        'rgba(255, 138, 101, 0.7)',   // Deep Orange
                        'rgba(158, 219, 177, 0.7)',   // Mint
                        'rgba(234, 128, 252, 0.7)',   // Light Purple
                        'rgba(183, 223, 253, 0.7)'    // Light Blue
                    ];
                    
                    const borderColors = [
                        'rgba(255, 99, 132, 1)',      // Pink
                        'rgba(54, 162, 235, 1)',      // Blue
                        'rgba(255, 206, 86, 1)',      // Yellow
                        'rgba(75, 192, 192, 1)',      // Teal
                        'rgba(153, 102, 255, 1)',     // Purple
                        'rgba(255, 159, 64, 1)',      // Orange
                        'rgba(129, 199, 132, 1)',     // Green
                        'rgba(121, 134, 203, 1)',     // Indigo
                        'rgba(255, 138, 101, 1)',     // Deep Orange
                        'rgba(158, 219, 177, 1)',     // Mint
                        'rgba(234, 128, 252, 1)',     // Light Purple
                        'rgba(183, 223, 253, 1)'      // Light Blue
                    ];
                    
                    // Return colors based on count
                    const bgColors = [];
                    const borders = [];
                    
                    // Smart color assignment to avoid adjacent repetition
                    if (count <= baseColors.length) {
                        // If we have enough colors, just use them directly
                        for (let i = 0; i < count; i++) {
                            bgColors.push(baseColors[i]);
                            borders.push(borderColors[i]);
                        }
                    } else {
                        // If we need more colors than we have in our palette
                        const colorCount = baseColors.length;
                        let lastIndex = -1;
                        
                        for (let i = 0; i < count; i++) {
                            // Choose next color avoiding the last one used when repeating
                            let index;
                            if (i >= colorCount) {
                                // When we start repeating, make sure we don't use adjacent duplicates
                                // Find an index different from the last one used
                                do {
                                    index = Math.floor(Math.random() * colorCount);
                                } while (index === lastIndex);
                            } else {
                                index = i;
                            }
                            
                            bgColors.push(baseColors[index]);
                            borders.push(borderColors[index]);
                            lastIndex = index;
                        }
                    }
                    
                    return { background: bgColors, border: borders };
                };
                
                const topicCount = {{ topic_counts|length }};
                const colors = generateColors(topicCount);
                
                const topicProgressChart = new Chart(topicProgressCtx.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: [{% for topic_name, count in topic_counts.items() %}'{{ topic_name }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                        datasets: [{
                            data: [{% for topic_name, count in topic_counts.items() %}{{ count }}{% if not loop.last %}, {% endif %}{% endfor %}],
                            backgroundColor: colors.background,
                            borderColor: colors.border,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: {
                                        family: "'Comic Neue', cursive",
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        {% endif %}
        
        // Email Reminder Widget Controls
        const reminderToggleBtn = document.getElementById('reminderToggleBtn');
        const reminderCloseBtn = document.getElementById('reminderCloseBtn');
        const reminderWidget = document.getElementById('reminderWidget');
        const reminderTypeSelect = document.getElementById('reminderType');
        const reminderFrequencySelect = document.getElementById('reminderFrequency');
        const daysBeforeOptions = document.querySelector('.days-before-options');
        const customMessageSection = document.querySelector('.custom-message-section');
        
        // Toggle reminder widget visibility
        if (reminderToggleBtn && reminderWidget) {
            reminderToggleBtn.addEventListener('click', function() {
                reminderWidget.classList.toggle('active');
                
                // Scroll to widget if it's now active
                if (reminderWidget.classList.contains('active')) {
                    setTimeout(() => {
                        reminderWidget.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }
            });
        }
        
        // Close reminder widget
        if (reminderCloseBtn && reminderWidget) {
            reminderCloseBtn.addEventListener('click', function() {
                reminderWidget.classList.remove('active');
            });
        }
        
        // Show/hide fields based on selections
        if (reminderTypeSelect) {
            reminderTypeSelect.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customMessageSection.classList.add('active');
                } else {
                    customMessageSection.classList.remove('active');
                }
            });
        }
        
        if (reminderFrequencySelect) {
            reminderFrequencySelect.addEventListener('change', function() {
                if (this.value === 'days_before') {
                    daysBeforeOptions.classList.add('active');
                } else {
                    daysBeforeOptions.classList.remove('active');
                }
            });
        }
        
        // Initialize conditional fields
        if (reminderTypeSelect && reminderTypeSelect.value === 'custom') {
            customMessageSection.classList.add('active');
        }
        
        if (reminderFrequencySelect && reminderFrequencySelect.value === 'days_before') {
            daysBeforeOptions.classList.add('active');
        }
    });
</script>
{% endblock %}