{% extends "base.html" %}

{% block title %}Statistics - {{ test.name }}{% endblock %}

{% block page_title %}Statistics for {{ test.name }}{% endblock %}

{% block subtitle %}{{ subject_name }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{{ url_for('index') }}">Home</a>
    <span class="separator">‚Ä∫</span>
    <a href="{{ url_for('subject_details', subject_name=subject_name) }}">{{ subject_name }}</a>
    <span class="separator">‚Ä∫</span>
    <span class="current">{{ test.name }} - Statistics</span>
</div>
{% endblock %}

{% block content %}
<!-- Test Info Card -->
<div class="test-info">
    <p><strong>Test:</strong> {{ test.name }}</p>
    <p class="date"><strong>Date:</strong> {{ test.date }}</p>
    
    {% if test.date %}
        {% if test.days_remaining is defined %}
            <p class="date">
                <strong>Status:</strong> 
                {% if test.days_remaining < 0 %}
                    <span class="past-test">Past test ({{ test.days_remaining|abs }} days ago)</span>
                {% elif test.days_remaining == 0 %}
                    <span class="today-test">Today!</span>
                {% elif test.days_remaining <= 7 %}
                    <span class="urgent-test">Urgent! {{ test.days_remaining }} days left</span>
                {% elif test.days_remaining <= 14 %}
                    <span class="soon-test">Coming soon - {{ test.days_remaining }} days left</span>
                {% else %}
                    <span class="future-test">{{ test.days_remaining }} days left</span>
                {% endif %}
            </p>
        {% endif %}
    {% endif %}

    <!-- Calculate and display statistics -->
    {% set total_resources = namespace(count=0) %}
    {% set completed_resources = namespace(count=0) %}

    {% for topic in test.topics %}
        {% for resource in topic.resources %}
            {% set total_resources.count = total_resources.count + resource.count %}
            {% set completed_resources.count = completed_resources.count + resource.completed if resource.completed is defined else completed_resources.count %}
        {% endfor %}
    {% endfor %}

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-title">Completion Rate</div>
            <div class="stat-value">
                {{ completed_resources.count }} of {{ total_resources.count }} completed
                {% if total_resources.count > 0 %}
                    ({{ (completed_resources.count / total_resources.count * 100)|round|int }}%)
                {% else %}
                    (0%)
                {% endif %}
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-title">Total Progress</div>
            <div class="progress-container">
                <div class="progress-bar" style="width: {% if total_resources.count > 0 %}{{ (completed_resources.count / total_resources.count * 100)|round|int }}{% else %}0{% endif %}%"></div>
                <span class="progress-percentage">
                    {% if total_resources.count > 0 %}
                        {{ (completed_resources.count / total_resources.count * 100)|round|int }}%
                    {% else %}
                        0%
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
    
    <!-- Study Streak -->
    {% if date_counts %}
        {% set streak = namespace(count=0, current=0) %}
        {% set dates = [] %}
        
        {% for date_str, count in date_counts %}
            {% if dates.append(date_str) %}{% endif %}
        {% endfor %}
        
        {% if dates|length > 0 %}
            {% set dates = dates|sort %}
            {% set last_date = dates[-1] %}
            
            <!-- Calculate current streak -->
            {% set streak.current = 1 %}
            {% for i in range(dates|length - 2, -1, -1) %}
                {% set prev_date = dates[i] %}
                {% set days_diff = 1 %} <!-- Placeholder - ideally calculate actual difference -->
                
                {% if days_diff == 1 %}
                    {% set streak.current = streak.current + 1 %}
                {% else %}
                    {% break %}
                {% endif %}
            {% endfor %}
            
            <div class="stat-card streak-card">
                <div class="stat-title">Current Streak</div>
                <div class="stat-value">{{ streak.current }} day{{ 's' if streak.current != 1 }}</div>
            </div>
        {% endif %}
    {% endif %}
    
    <div class="cat-paw">üêæ</div>
</div>

<!-- Charts Section - Grid Layout -->
<div class="dashboard-grid charts-grid">
    <!-- Daily Progress Chart -->
    <div class="widget chart-widget">
        <div class="widget-header">
            <h3 class="widget-title daily-chart">Daily Progress</h3>
        </div>
        <div class="widget-content">
            {% if date_counts %}
                <div class="chart-wrapper">
                    <canvas id="dailyProgressChart"></canvas>
                </div>
                
                <!-- Estimated readiness calculation -->
                {% set consistency = namespace(score=0) %}
                {% if date_counts|length > 0 %}
                    <!-- Higher consistency score for regular studying -->
                    {% set consistency.score = 25 * (date_counts|length / 14) %}
                    <!-- Cap at 25% -->
                    {% if consistency.score > 25 %}
                        {% set consistency.score = 25 %}
                    {% endif %}
                {% endif %}
                
                {% set progress_score = 0 %}
                {% if total_resources.count > 0 %}
                    {% set progress_score = 50 * (completed_resources.count / total_resources.count) %}
                {% endif %}
                
                {% set readiness = consistency.score + progress_score %}
                {% if readiness > 75 %}
                    {% set readiness_class = "excellent" %}
                {% elif readiness > 50 %}
                    {% set readiness_class = "good" %}
                {% elif readiness > 25 %}
                    {% set readiness_class = "fair" %}
                {% else %}
                    {% set readiness_class = "poor" %}
                {% endif %}
                
                <div class="readiness-score {{ readiness_class }}">
                    <div class="readiness-title">Estimated Readiness</div>
                    <div class="readiness-value">{{ readiness|round|int }}%</div>
                    <div class="readiness-bar">
                        <div class="readiness-progress" style="width: {{ readiness|round|int }}%"></div>
                    </div>
                </div>
            {% else %}
                <div class="no-data">No progress data available yet. Start tracking your progress!</div>
            {% endif %}
        </div>
    </div>

    <!-- Progress by Topic Chart -->
    <div class="widget chart-widget">
        <div class="widget-header">
            <h3 class="widget-title topic-chart">Progress by Topic</h3>
        </div>
        <div class="widget-content">
            {% if topic_counts %}
                <div class="chart-wrapper">
                    <canvas id="topicProgressChart"></canvas>
                </div>
                <div class="stats-distribution">
                    {% for topic_name, count in topic_counts.items() %}
                        <div class="stats-item">
                            <div class="stats-item-title">{{ topic_name }}</div>
                            <div class="stats-item-value">{{ count }} resources completed</div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="no-data">No topic data available yet. Start tracking your progress!</div>
            {% endif %}
        </div>
    </div>

    <!-- Topic Completion Details -->
    <div class="widget topic-details-widget">
        <div class="widget-header">
            <h3 class="widget-title topic-details">Topic Details</h3>
        </div>
        <div class="widget-content">
            <div class="topic-details-wrapper">
                {% if test.topics and test.topics|length > 0 %}
                    <div class="topics-resources-list">
                        {% for topic in test.topics %}
                            <div class="topic-section">
                                <div class="topic-name">{{ topic.name }}</div>
                                <div class="resources-progress-list">
                                    {% if topic.resources and topic.resources|length > 0 %}
                                        {% for resource in topic.resources %}
                                            <div class="resource-progress-item">
                                                <div class="resource-info">
                                                    <div class="resource-name-container">
                                                        <span class="resource-name">{{ resource.name }}</span>
                                                        {% if resource.completed is defined and resource.completed >= resource.count %}
                                                            <span class="completion-check">‚úì</span>
                                                        {% endif %}
                                                    </div>
                                                    <span class="resource-count">({{ resource.completed if resource.completed is defined else 0 }}/{{ resource.count }})</span>
                                                </div>
                                                <div class="resource-progress-bar">
                                                    <div class="resource-progress" style="width: {{ (resource.completed / resource.count * 100) if resource.completed is defined and resource.count > 0 else 0 }}%"></div>
                                                </div>
                                                
                                                <!-- Display scores if they exist -->
                                                {% if resource.scores and resource.scores|length > 0 %}
                                                    <div class="resource-scores">
                                                        <span class="score-label">Scores:</span>
                                                        {% for score in resource.scores %}
                                                            <span class="score-badge">{{ score }}%</span>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="no-resources">No resources for this topic.</div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="no-data">No topics available yet. Add topics and resources to see details!</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Study Time Analysis -->
    <div class="widget study-time-widget">
        <div class="widget-header">
            <h3 class="widget-title study-time">Study Time Distribution</h3>
        </div>
        <div class="widget-content">
            <div class="study-time-wrapper">
                {% if date_counts %}
                    <div class="study-metrics">
                        {% set total_completed = namespace(count=0) %}
                        {% for date, count in date_counts %}
                            {% set total_completed.count = total_completed.count + count %}
                        {% endfor %}

                        <div class="metric-card">
                            <div class="metric-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                </svg>
                            </div>
                            <div class="metric-value">{{ total_completed.count }}</div>
                            <div class="metric-label">Resources Completed</div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                            </div>
                            <div class="metric-value">{{ (total_completed.count * 0.5)|round(1) }}</div>
                            <div class="metric-label">Study Hours (est.)</div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                            </div>
                            <div class="metric-value">{{ date_counts|length }}</div>
                            <div class="metric-label">Study Days</div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                </svg>
                            </div>
                            <div class="metric-value">{{ (total_completed.count / date_counts|length)|round(1) if date_counts|length > 0 else 0 }}</div>
                            <div class="metric-label">Daily Average</div>
                        </div>
                    </div>
                {% else %}
                    <div class="no-data">No study time data available yet. Start tracking your progress!</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="button-group">
    <a href="{{ url_for('track_progress', subject_name=subject_name, test_id=test.id) }}" class="btn btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="btn-icon">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        Track Progress
    </a>
    
    <a href="{{ url_for('subject_details', subject_name=subject_name) }}" class="btn btn-secondary">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="btn-icon">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        Back to Subject
    </a>
    
    <form action="{{ url_for('send_test_reminder', subject_name=subject_name, test_id=test.id) }}" method="post" style="display: inline;">
        <button type="submit" class="btn btn-secondary">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="btn-icon">
                <path d="M22 17H2a3 3 0 0 0 3-3V9a7 7 0 0 1 14 0v5a3 3 0 0 0 3 3zm-8.27 4a2 2 0 0 1-3.46 0"></path>
            </svg>
            Send Reminder
        </button>
    </form>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Base styles */
    .test-info {
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 15px;
        padding: 25px;
        margin: 30px 0;
        box-shadow: 5px 5px 0 var(--primary-light);
        border: 3px solid var(--primary);
        position: relative;
    }

    .test-info p {
        font-size: 1.3rem;
        margin: 8px 0;
    }

    .test-info .date {
        font-weight: bold;
        color: var(--primary-dark);
    }
    
    /* Status colors */
    .past-test {
        color: var(--dark);
    }
    .today-test {
        color: #ff5f8f;
        font-weight: bold;
    }
    .urgent-test {
        color: var(--danger);
        font-weight: bold;
    }
    .soon-test {
        color: var(--warning);
        font-weight: bold;
    }
    .future-test {
        color: var(--success);
    }

    /* Readiness score */
    .readiness-score {
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 10px;
        padding: 15px;
        margin-top: 15px;
        text-align: center;
    }
    
    .readiness-title {
        font-weight: bold;
        font-size: 1.1rem;
        margin-bottom: 5px;
    }
    
    .readiness-value {
        font-size: 1.8rem;
        font-weight: bold;
        margin: 5px 0;
    }
    
    .readiness-bar {
        height: 10px;
        background-color: #f0f0f0;
        border-radius: 5px;
        overflow: hidden;
        margin-top: 10px;
    }
    
    .readiness-progress {
        height: 100%;
        transition: width 0.3s ease;
    }
    
    .excellent .readiness-value {
        color: #4CAF50;
    }
    
    .excellent .readiness-progress {
        background-color: #4CAF50;
    }
    
    .good .readiness-value {
        color: #8BC34A;
    }
    
    .good .readiness-progress {
        background-color: #8BC34A;
    }
    
    .fair .readiness-value {
        color: #FFC107;
    }
    
    .fair .readiness-progress {
        background-color: #FFC107;
    }
    
    .poor .readiness-value {
        color: #FF5722;
    }
    
    .poor .readiness-progress {
        background-color: #FF5722;
    }

    /* Dashboard Grid Layout */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin: 30px 0;
    }

    .widget {
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 15px;
        padding: 20px;
        border: 3px solid var(--primary);
        box-shadow: 5px 5px 0 var(--primary-light);
        position: relative;
        backdrop-filter: blur(5px);
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .widget:hover {
        transform: translateY(-3px);
        box-shadow: 8px 8px 0 var(--primary-light);
    }

    .widget-header {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px dashed var(--primary-light);
    }

    .widget-title {
        font-family: 'Bangers', cursive;
        color: var(--secondary);
        font-size: 1.6rem;
        margin: 0;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
    }

    .widget-title::before {
        margin-right: 10px;
        font-size: 1.4rem;
    }

    .widget-title.daily-chart::before {
        content: "üìÖ";
    }

    .widget-title.topic-chart::before {
        content: "üìä";
    }

    .widget-title.topic-details::before {
        content: "üìù";
    }

    .widget-title.study-time::before {
        content: "‚è±Ô∏è";
    }

    .widget-content {
        height: 300px;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .chart-wrapper {
        width: 100%;
        flex: 1;
        min-height: 0; /* Important for flex container to allow proper sizing */
        position: relative;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-top: 15px;
    }

    .stat-card {
        background-color: var(--light);
        border-radius: 10px;
        padding: 15px;
        box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.1);
    }

    .stat-title {
        font-weight: bold;
        color: var(--secondary);
        margin-bottom: 10px;
        font-size: 1.1rem;
    }

    .stat-value {
        font-size: 1.2rem;
        color: var(--dark);
    }

    .progress-container {
        position: relative;
        width: 100%;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 5px;
    }

    .progress-bar {
        height: 100%;
        background-color: var(--success);
        transition: width 0.3s ease;
    }

    .progress-percentage {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        text-align: center;
        line-height: 20px;
        font-size: 0.9rem;
        font-weight: bold;
        color: var(--dark);
        text-shadow: 0 0 2px rgba(255, 255, 255, 0.7);
    }

    /* Stats Distribution */
    .stats-distribution {
        margin-top: 15px;
        max-height: 120px;
        overflow-y: auto;
        padding-right: 5px;
    }

    .stats-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 12px;
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        margin-bottom: 6px;
    }

    .stats-item-title {
        font-weight: bold;
    }

    .stats-item-value {
        color: var(--secondary-dark);
    }

    /* Study Metrics */
    .study-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-template-rows: repeat(2, 1fr);
        gap: 15px;
        height: 100%;
        padding: 10px;
    }

    .metric-card {
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .metric-icon {
        font-size: 2rem;
        margin-bottom: 5px;
        color: var(--secondary);
    }

    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--secondary-dark);
    }

    .metric-label {
        font-size: 0.9rem;
        color: var(--dark);
    }

    /* Topic Details */
    .topics-resources-list {
        max-height: 280px;
        overflow-y: auto;
        padding-right: 10px;
    }

    .topic-section {
        margin-bottom: 15px;
    }

    .topic-name {
        font-weight: bold;
        font-size: 1.1rem;
        color: var(--secondary);
        padding: 5px 10px;
        margin-bottom: 8px;
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        border-left: 4px solid var(--secondary);
    }

    .resources-progress-list {
        margin-left: 10px;
    }

    .resource-progress-item {
        margin-bottom: 10px;
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        padding: 10px;
    }

    .resource-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }

    .resource-name-container {
        display: flex;
        align-items: center;
    }

    .resource-name {
        font-weight: bold;
        color: var(--dark);
    }

    .completion-check {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        background-color: var(--success);
        color: white;
        border-radius: 50%;
        margin-left: 8px;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .resource-count {
        font-size: 0.9rem;
        color: var(--dark);
    }

    .resource-progress-bar {
        height: 10px;
        background-color: #f0f0f0;
        border-radius: 5px;
        overflow: hidden;
    }

    .resource-progress {
        height: 100%;
        background-color: var(--success);
        transition: width 0.3s ease;
    }
    
    /* Resource Scores */
    .resource-scores {
        margin-top: 8px;
        font-size: 0.9rem;
    }
    
    .score-label {
        font-style: italic;
        margin-right: 5px;
    }
    
    .score-badge {
        background-color: var(--secondary-light);
        padding: 2px 6px;
        border-radius: 10px;
        margin-right: 5px;
        font-size: 0.8rem;
    }

    .no-resources, .no-data {
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        font-style: italic;
        color: var(--dark);
        background-color: rgba(255, 255, 255, 0.5);
        border-radius: 10px;
        border: 1px dashed var(--primary);
        padding: 20px;
    }

    /* Streak Card */
    .streak-card {
        grid-column: 1 / span 2;
        margin-top: 15px;
        background-color: var(--primary-light);
        border-left: 4px solid var(--primary);
        transition: all 0.3s ease;
    }
    
    .streak-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .streak-card .stat-title {
        color: var(--primary-dark);
    }
    
    .streak-card .stat-value {
        font-size: 1.4rem;
        font-weight: bold;
        color: var(--primary-dark);
    }

    /* Button Group */
    .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin-top: 30px;
    }

    .btn {
        padding: 12px 20px;
        border-radius: 10px;
        font-family: 'Comic Neue', cursive;
        font-weight: bold;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        border: 2px solid var(--dark);
        box-shadow: 3px 3px 0 var(--dark);
    }

    .btn:hover {
        transform: translateY(-3px);
        box-shadow: 5px 5px 0 var(--dark);
    }

    .btn-primary {
        background-color: var(--secondary);
        color: white;
    }

    .btn-secondary {
        background-color: var(--primary);
        color: white;
    }

    .btn-icon {
        margin-right: 8px;
        font-size: 1.2rem;
    }

    .cat-paw {
        position: absolute;
        bottom: -15px;
        right: -15px;
        font-size: 1.8rem;
        transform: rotate(15deg);
    }

    /* Responsive Design */
    @media (max-width: 992px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .button-group {
            flex-direction: column;
        }

        .widget-content {
            height: 250px;
        }
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    // JavaScript to create charts
    document.addEventListener('DOMContentLoaded', function() {
        // Set Chart.js defaults
        Chart.defaults.font.family = "'Comic Neue', cursive";
        Chart.defaults.font.size = 14;
        Chart.defaults.color = "#333";
        Chart.defaults.borderColor = "rgba(106, 90, 205, 0.2)";

        // Safely get element and check if it exists before creating charts
        const dailyProgressCtx = document.getElementById('dailyProgressChart');
        const topicProgressCtx = document.getElementById('topicProgressChart');

        {% if date_counts %}
            // Only initialize if the element exists
            if (dailyProgressCtx) {
                const dailyProgressChart = new Chart(dailyProgressCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: [{% for date, count in date_counts %}'{{ date }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                        datasets: [{
                            label: 'Resources Completed',
                            data: [{% for date, count in date_counts %}{{ count }}{% if not loop.last %}, {% endif %}{% endfor %}],
                            backgroundColor: 'rgba(106, 90, 205, 0.7)',
                            borderColor: 'rgba(106, 90, 205, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(tooltipItems) {
                                        return tooltipItems[0].label;
                                    },
                                    label: function(context) {
                                        const resources = context.raw;
                                        return `${resources} resource${resources !== 1 ? 's' : ''} completed`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        {% endif %}

        {% if topic_counts %}
            // Only initialize if the element exists
            if (topicProgressCtx) {
                // Generate dynamic colors for better visualization
                const generateColors = (count) => {
                    const baseColors = [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)'
                    ];
                    
                    const borderColors = [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ];
                    
                    // Return colors based on count
                    const bgColors = [];
                    const borders = [];
                    
                    for (let i = 0; i < count; i++) {
                        bgColors.push(baseColors[i % baseColors.length]);
                        borders.push(borderColors[i % borderColors.length]);
                    }
                    
                    return { background: bgColors, border: borders };
                };
                
                const topicCount = {{ topic_counts|length }};
                const colors = generateColors(topicCount);
                
                const topicProgressChart = new Chart(topicProgressCtx.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: [{% for topic_name, count in topic_counts.items() %}'{{ topic_name }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                        datasets: [{
                            data: [{% for topic_name, count in topic_counts.items() %}{{ count }}{% if not loop.last %}, {% endif %}{% endfor %}],
                            backgroundColor: colors.background,
                            borderColor: colors.border,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: {
                                        family: "'Comic Neue', cursive",
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        {% endif %}
    });
</script>
{% endblock %}
